rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if user is active
    function isActive() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    // Helper function to get user permissions
    function getUserPermissions() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
    }

    // Helper function to check if user can view all records
    function canViewAll() {
      return isAdmin() || getUserPermissions().canViewAll == true;
    }

    // Helper function to check if user can edit
    function canEdit() {
      return isAdmin() || getUserPermissions().canEdit == true;
    }

    // Helper function to check if user can delete
    function canDelete() {
      return isAdmin() || getUserPermissions().canDelete == true;
    }

    // Helper function to check if user can only register
    function canOnlyRegister() {
      return !isAdmin() && getUserPermissions().canOnlyRegister == true;
    }

    // Helper function to check if resource belongs to user
    function isOwner(resource) {
      return resource.data.registeredBy.userId == request.auth.uid;
    }

    // Users collection - Only admins can manage users
    match /users/{userId} {
      // Anyone authenticated can read their own user document
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Only admins can read all users
      allow list: if isAdmin();

      // Permitir crear documento de usuario en estos casos:
      // 1. El usuario autenticado crea su propio documento (auto-registro)
      // 2. El createdBy es un usuario admin existente (admin creando usuarios)
      allow create: if isAuthenticated() && (
        // Auto-registro: el usuario crea su propio documento
        (request.auth.uid == userId && request.resource.data.createdBy == userId) ||
        // Admin creando usuario: verificar que createdBy sea un admin
        (request.resource.data.createdBy != null &&
         get(/databases/$(database)/documents/users/$(request.resource.data.createdBy)).data.role == 'admin')
      );

      // Permitir que un usuario autenticado actualice su propio documento
      allow update: if isAuthenticated() && request.auth.uid == userId;

      // Only admins can update/delete other users
      allow update, delete: if isAdmin();
    }

    // Mechanical problems collection
    match /mechanical-problems/{problemId} {
      // Read rules - para obtener un documento específico
      allow read: if isAuthenticated() &&
                    isActive() &&
                    !canOnlyRegister() &&
                    (canViewAll() || isOwner(resource));

      // List rules - usuarios autenticados y activos pueden listar
      // El filtrado por owner se hace en el cliente
      allow list: if isAuthenticated() &&
                     isActive() &&
                     !canOnlyRegister();

      // Create rules - authenticated and active users can create
      allow create: if isAuthenticated() &&
                      isActive() &&
                      request.resource.data.registeredBy.userId == request.auth.uid &&
                      request.resource.data.deleted == false &&
                      request.resource.data.problemType == 'mechanical';

      // Update rules - owner with permission or admin can update
      allow update: if isAuthenticated() &&
                      isActive() &&
                      (isAdmin() || (isOwner(resource) && canEdit()));

      // Delete rules (soft delete) - owner with permission or admin can delete
      allow delete: if isAdmin(); // Only admin can permanently delete

      // Soft delete via update
      allow update: if isAuthenticated() &&
                      isActive() &&
                      (isAdmin() || (isOwner(resource) && canDelete())) &&
                      request.resource.data.deleted == true;
    }

    // Electrical problems collection
    match /electrical-problems/{problemId} {
      // Read rules - para obtener un documento específico
      allow read: if isAuthenticated() &&
                    isActive() &&
                    !canOnlyRegister() &&
                    (canViewAll() || isOwner(resource));

      // List rules - usuarios autenticados y activos pueden listar
      // El filtrado por owner se hace en el cliente
      allow list: if isAuthenticated() &&
                     isActive() &&
                     !canOnlyRegister();

      // Create rules - authenticated and active users can create
      allow create: if isAuthenticated() &&
                      isActive() &&
                      request.resource.data.registeredBy.userId == request.auth.uid &&
                      request.resource.data.deleted == false &&
                      request.resource.data.problemType == 'electrical';

      // Update rules - owner with permission or admin can update
      allow update: if isAuthenticated() &&
                      isActive() &&
                      (isAdmin() || (isOwner(resource) && canEdit()));

      // Delete rules (soft delete) - owner with permission or admin can delete
      allow delete: if isAdmin(); // Only admin can permanently delete

      // Soft delete via update
      allow update: if isAuthenticated() &&
                      isActive() &&
                      (isAdmin() || (isOwner(resource) && canDelete())) &&
                      request.resource.data.deleted == true;
    }

    // Legacy problems collection (for backward compatibility)
    match /problems/{problemId} {
      // Read rules - para obtener un documento específico
      allow read: if isAuthenticated() &&
                    isActive() &&
                    !canOnlyRegister() &&
                    (canViewAll() || isOwner(resource));

      // List rules - usuarios autenticados y activos pueden listar
      // El filtrado por owner se hace en el cliente
      allow list: if isAuthenticated() &&
                     isActive() &&
                     !canOnlyRegister();

      // Create rules
      allow create: if isAuthenticated() &&
                      isActive() &&
                      request.resource.data.registeredBy.userId == request.auth.uid;

      // Update rules
      allow update: if isAuthenticated() &&
                      isActive() &&
                      (isAdmin() || (isOwner(resource) && canEdit()));

      // Delete rules
      allow delete: if isAdmin();
    }

    // Work order collection
    match /work_order_db/{document=**} {
      allow read: if isAuthenticated() && isActive();
      allow write: if isAdmin();
    }

    // Deny access to any other unspecified collection
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
